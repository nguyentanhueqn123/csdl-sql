CREATE DATABASE QLBH
USE QLBH
-- CAU 1
CREATE TABLE KHACHHANG
(
	MAKH CHAR(4),
	HOTEN VARCHAR(40),
	DCHI VARCHAR(50),
	SODT VARCHAR(20),
	NGSINH SMALLDATETIME,
	NGDK SMALLDATETIME,
	DOANHSO MONEY,
	PRIMARY KEY(MAKH)
)
CREATE TABLE NHANVIEN
(
	MANV CHAR(4),
	HOTEN VARCHAR(40),
	SODT VARCHAR(20),
	NGVL SMALLDATETIME,
	PRIMARY KEY(MANV)
)
CREATE TABLE SANPHAM
(
	MASP CHAR(4),
	TENSP VARCHAR(40),
	DVT VARCHAR(20),
	NUOCSX VARCHAR(40),
	GIA MONEY,
	PRIMARY KEY(MASP)
)
CREATE TABLE HOADON
(
	SOHD INT,
	NGHD SMALLDATETIME,
	MAKH CHAR(4),
	MANV CHAR(4),
	TRIGIA MONEY,
	PRIMARY KEY(SOHD)
)
CREATE TABLE CTHD
(
	SL INT,
	MASP CHAR(4) FOREIGN KEY REFERENCES SANPHAM(MASP),
	SOHD INT FOREIGN KEY REFERENCES HOADON(SOHD),
	PRIMARY KEY(SOHD, MASP)
)
-- CAU 2
ALTER TABLE SANPHAM ADD GHICHU VARCHAR(20)
-- CAU 3
ALTER TABLE KHACHHANG ADD LOAIKH TINYINT  
-- CAU 4
ALTER TABLE SANPHAM ALTER COLUMN GHICHU VARCHAR(100)
-- CAU 5
ALTER TABLE SANPHAM DROP COLUMN GHICHU
-- CAU 6
ALTER TABLE KHACHHANG ALTER COLUMN LOAIKH VARCHAR(100)
-- CAU 7
ALTER TABLE SANPHAM ADD CONSTRAINT CK_DVT CHECK (DVT in('cay','hop','cai','quyen','chuc'))
-- CAU 8
ALTER TABLE SANPHAM ADD CONSTRAINT CK_GIA CHECK (GIA >=500)
-- CAU 9
ALTER TABLE CTHD ADD CONSTRAINT CK_SL CHECK (SL>=1)
-- CAU 10
ALTER TABLE KHACHHANG ADD CONSTRAINT CK_NGDK CHECK(NGDK>NGSINH)

-- CAU 11
GO
CREATE TRIGGER NGAYHOADON ON HOADON
FOR INSERT, UPDATE
AS
BEGIN
	IF
	(
		EXISTS
		(
			SELECT * FROM KHACHHANG, INSERTED
			WHERE KHACHHANG.MAKH = INSERTED.MAKH
				AND KHACHHANG.NGAYDK > INSERTED.NGAYHD
		)
	)
	BEGIN
		PRINT 'Error'
		ROLLBACK TRANSACTION
	END
END
GO
CREATE TRIGGER NGAYDKKHACHHANG ON KHACHHANG
FOR UPDATE
AS
BEGIN
	IF
	(
		EXISTS
		(
			SELECT * FROM HOADON, INSERTED
			WHERE HOADON.MAKH = INSERTED.MAKH
				AND HOADON.NGAYHD < INSERTED.NGAYDK
		)
	)
	BEGIN
		PRINT 'Error'
		ROLLBACK TRANSACTION
	END
END

-- CAU 12
GO
CREATE TRIGGER NGAYBANHANG ON HOADON
FOR INSERT, UPDATE
AS
BEGIN
	IF
	(
		EXISTS
		(
			SELECT * FROM NHANVIEN, INSERTED
			WHERE NHANVIEN.MANV = INSERTED.MANV
				AND NHANVIEN.NGAYVL > INSERTED.NGAYHD
		)
	)
	BEGIN
		PRINT 'Error'
		ROLLBACK TRANSACTION
	END
END

GO
CREATE TRIGGER NGAYVLNHANVIEN ON NHANVIEN
FOR UPDATE
AS
BEGIN
	IF
	(
		EXISTS
		(
			SELECT * FROM HOADON, INSERTED
			WHERE HOADON.MANV = INSERTED.MANV
				AND HOADON.NGAYHD < INSERTED.NGAYVL
		)
	)
	BEGIN
		PRINT 'Error'
		ROLLBACK TRANSACTION
	END
END

-- CAU 13
GO
CREATE TRIGGER CHITIETHD ON HOADON
AFTER INSERT
AS
BEGIN
	IF
	(
		NOT EXISTS
		(
			SELECT * FROM INSERTED CT JOIN CTHD HD ON HD.SOHD = CT.SOHD
		)
	)
	BEGIN
		ROLLBACK TRANSACTION
		PRINT 'Error'
	END
END

-- CAU 14
GO
CREATE TRIGGER INSERT_HOADON_C14
ON HOADON
FOR INSERT
AS
 UPDATE HOADON
 SET  TRIGIA=0
 WHERE SOHD=(SELECT  SOHD
    FROM  INSERTED)
 PRINT'DA INSERT 1 HOADON VOI TRIGIA BAN DAU LA 0 VND' 
 -------------
 GO
CREATE TRIGGER UPDATE_HOADON_C14
ON HOADON
FOR INSERT
AS
 UPDATE HOADON
 SET  TRIGIA=(SELECT TRIGIA
     FROM DELETED)
 WHERE SOHD=(SELECT  SOHD
    FROM  INSERTED)
 PRINT'DA UPDATE 1 HOADON VOI TRIGIA KHONG THAY DOI'
 -------------
 GO
CREATE TRIGGER INSERT_CTHD_C14
ON CTHD
FOR INSERT
AS
 DECLARE  @SL  INT,
   @GIA  MONEY,
   @SOHD INT

 SELECT @GIA=GIA,@SL=SL,@SOHD=SOHD
 FROM  INSERTED A, SANPHAM B
 WHERE A.MASP=B.MASP

 UPDATE HOADON
 SET  TRIGIA=TRIGIA+@SL*@GIA
  PRINT'DA INSERT 1 CTHD VA UPDATE LAI TRIGIA CUA HOADON TUONG UNG'
 --------------
GO
CREATE TRIGGER DELETE_CTHD_C14
ON CTHD
FOR DELETE
AS
 DECLARE  @SL  INT,
   @GIA  MONEY,
   @SOHD INT

 SELECT @GIA=GIA,@SL=SL,@SOHD=SOHD
 FROM  DELETED A, SANPHAM B
 WHERE A.MASP=B.MASP

 UPDATE HOADON
 SET  TRIGIA=TRIGIA-@SL*@GIA
  PRINT'DA DELETE 1 CTHD VA UPDATE LAI TRIGIA CUA HOADON TUONG UNG'
 -------------------
 GO
CREATE TRIGGER UPDATE_CTHD_C14
ON CTHD
FOR UPDATE
AS
 DECLARE  @SL_CU INT,
   @SL_MOI INT,   
   @GIA_CU MONEY,
   @GIA_MOI MONEY,
   @SOHD_CU INT,
   @SOHD_MOI INT

 SELECT @GIA_CU=GIA,@SL_CU=SL,@SOHD_CU=SOHD
 FROM  DELETED A, SANPHAM B
 WHERE A.MASP=B.MASP
 
 SELECT @GIA_MOI=GIA,@SL_MOI=SL,@SOHD_MOI=SOHD
 FROM  INSERTED A, SANPHAM B
 WHERE A.MASP=B.MASP

 IF(@SOHD_CU=@SOHD_MOI)
  BEGIN
   UPDATE HOADON
   SET  TRIGIA=TRIGIA+@SL_MOI*@GIA_MOI-@SL_CU*@GIA_CU
   WHERE SOHD=@SOHD_CU
  END
 ELSE
  BEGIN
   UPDATE HOADON
   SET  TRIGIA=TRIGIA-@SL_CU*@GIA_CU
   WHERE SOHD=@SOHD_CU

   UPDATE HOADON
   SET  TRIGIA=TRIGIA+@SL_MOI*@GIA_MOI
   WHERE SOHD=@SOHD_MOI
  END
 PRINT'DA UPDATE 1 CTHD VA UPDATE LAI TRIGIA CUA HOADON TUONG UNG'
 -------------------
GO
CREATE TRIGGER UPDATE_HOADON_C14
ON  HOADON
FOR  INSERT
AS
 DECLARE @GIA_CU MONEY,
   @GIA_MOI MONEY,
   @SOHD INT,
   @SL  INT
   
 SELECT @GIA_CU=GIA
 FROM  DELETED
 SELECT @GIA_MOI=GIA
 FROM  INSERTED

 SELECT @SOHD=SOHD,@SL=SL
 FROM  INSERTED A, CTHD B
 WHERE A.MASP=B.MASP

 UPDATE HOADON
 SET  TRIGIA=TRIGIA+@SL*(@GIA_MOI-@GIA_CU) 
 WHERE SOHD=@SOHD
  PRINT'DA UPDATE 1 HOADON VOI TRIGIA KHONG THAY DOI'

-- CAAU 15
GO
CREATE TRIGGER INSERT_KHACHHANG_C15
ON KHACHHANG
FOR INSERT
AS
 DECLARE @MAKH CHAR(4)

 SELECT @MAKH=MAKH
 FROM  INSERTED
 
 UPDATE KHACHHANG
 SET  DOANHSO=0
 WHERE MAKH=@MAKH

 PRINT 'DA INSERT 1 KHACHHANG MOI VOI DOANHSO BAN DAU LA 0 VND'
 ----------------
 GO
CREATE TRIGGER UPDATE_KHACHHANG_C15
ON KHACHHANG
FOR UPDATE
AS
 DECLARE @MAKH  CHAR(4),
   @DOANHSO_CU MONEY

 SELECT @MAKH=MAKH
 FROM  INSERTED
 
 SELECT @DOANHSO_CU=DOANHSO
 FROM  DELETED
 
 UPDATE KHACHHANG
 SET  DOANHSO=@DOANHSO_CU
 WHERE MAKH=@MAKH

 PRINT 'DA UPDATE 1 KHACHHANG'
 ----------------
GO
CREATE TRIGGER INSERT_HOADON_C15
ON HOADON
FOR INSERT
AS
 DECLARE @TRIGIA MONEY,
   @MAKH CHAR(4)

 SELECT @MAKH=MAKH,@TRIGIA=TRIGIA
 FROM  INSERTED
 
 UPDATE KHACHHANG
 SET  DOANHSO=DOANHSO+@TRIGIA
 WHERE MAKH=@MAKH

 PRINT 'DA INSERT 1 HODON MOI VA UPDATE LAI DOANHSO CUA KH CO SOHD TREN'

 -----------
 GO
CREATE TRIGGER DELETE_HOADON_C15
ON HOADON
FOR DELETE
AS
 DECLARE @TRIGIA MONEY,
   @MAKH CHAR(4)

 SELECT @MAKH=MAKH,@TRIGIA=TRIGIA
 FROM  DELETED
 
 UPDATE KHACHHANG
 SET  DOANHSO=DOANHSO-@TRIGIA
 WHERE MAKH=@MAKH

 PRINT 'DA DELETE 1 HODON MOI VA UPDATE LAI DOANHSO CUA KH CO SOHD TREN'
 ---------------
CREATE TRIGGER UPDATE_HOADON_C15
ON HOADON
FOR UPDATE
AS
 DECLARE @TRIGIA_CU MONEY,
   @TRIGIA_MOI MONEY,
   @MAKH  CHAR(4)

 SELECT @MAKH=MAKH,@TRIGIA_MOI=TRIGIA
 FROM  INSERTED

 SELECT @MAKH=MAKH,@TRIGIA_CU=TRIGIA
 FROM  DELETED
  
 UPDATE KHACHHANG
 SET  DOANHSO=DOANHSO+@TRIGIA_MOI-@TRIGIA_CU
 WHERE MAKH=@MAKH



-- PHAN 2
-- CAU 1
SET DATEFORMAT DMY
SELECT *FROM SANPHAM;
INSERT INTO NHANVIEN (MANV, HOTEN, SODT, NGVL) VALUES ('NV01', 'Nguyen Nhu Nhut', '0927345678', '13/4/2006')
INSERT INTO NHANVIEN (MANV, HOTEN, SODT, NGVL) VALUES ('NV02', 'Le Thi Phi Yen', '0987567390', '21/4/2006')
INSERT INTO NHANVIEN (MANV, HOTEN, SODT, NGVL) VALUES ('NV03', 'Nguyen Van B', '0997047382', '27/4/2006')
INSERT INTO NHANVIEN (MANV, HOTEN, SODT, NGVL) VALUES ('NV04', 'Ngo Thanh Tuan', '0913758498', '24/6/2006')
INSERT INTO NHANVIEN (MANV, HOTEN, SODT, NGVL) VALUES ('NV05', 'Nguyen Thi Truc Thanh', '0918590387', '20/7/2006')

INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH01', 'Nguyen Van A', '731, Tran Hung Dao, Q5, TPHCM', '08823451', '22/10/1960', 13060000, '22/07/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH02', 'Tran Ngoc Han', '23/5 Nguyen Trai, Q5, TpHCM', '0908256478', '03/04/1974', 280000, '30/07/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH03', 'Tran Ngoc Linh', '45 Nguyen Canh Chan, Q1, TpHCM', '0938776266', '12/06/1980', 3860000, '05/08/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH04', 'Tran Minh Long', '50/34 Le Dai hanh, Q10, TpHCM', '0917325476', '09/03/1965', 250000, '02/10/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH05', 'Le Nhat Minh', '34 Truong Dinh, Q3, TPHCM', '08246108', '10/03/1960', 21000, '28/10/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH06', 'Le Hoai Thuong', '227 Nguyen Van Cu, Q5, TpHCM', '08631738', '31/12/1981', 915000, '24/11/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH07', 'Nguyen Van Tam', '32/3 Tran Binh Trong, Q5, TpHCM', '0916783565', '06/04/1971', 12500, '01/12/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH08', 'Phan Thi Thanh', '45/2 An Duong Vuong, Q5, TPHCM', '0938435756', '10/01/1971', 365000, '13/12/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH09', 'Le Ha Vinh', '873 Le Hong Phong, Q5, TPHCM', '08654763', '03/09/1979', 70000, '14/01/2007')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH10', 'Ha Duy Lap', '34/34B Nguyen Trai, Q1, TPHCM', '08768904', '02/05/1963', 67500, '16/01/2007')

INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BC01', 'But Chi', 'cay', 'Singapore', 3000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BC02', 'But Chi', 'cay', 'Singapore', 5000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BC03', 'But Chi', 'cay', 'Viet Nam', 3500)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BC04', 'But Chi', 'hop', 'Viet Nam', 30000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BB01', 'But bi', 'cay', 'Viet Nam', 5000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BB02', 'But bi', 'cay', 'Trung Quoc', 7000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BB03', 'But bi', 'hop', 'Thai Lan', 100000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV01', 'Tap 100 giay mong', 'quyen', 'Trung Quoc', 2500)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV02', 'Tap 200 giay mong', 'quyen', 'Trung Quoc', 4500)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV03', 'Tap 100 giay tot', 'quyen', 'Viet Nam', 3000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV04', 'Tap 200 giay tot', 'quyen', 'Viet Nam', 5500)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV05', 'Tap 100 trang', 'chuc', 'Viet Nam', 23000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV06', 'Tap 200 trang', 'chuc', 'Viet Nam', 53000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV07', 'Tap 100 trang', 'chuc', 'Trung Quoc', 34000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST01', 'So tay 500 trang', 'quyen', 'Trung Quoc', 40000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST02', 'So tay loai 1', 'quyen', 'Viet Nam', 55000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST03', 'So tay loai 2', 'quyen', 'Viet Nam', 51000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST04', 'So tay', 'quyen', 'Thai Lan', 55000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST05', 'So tay mong', 'quyen', 'Thai Lan', 20000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST06', 'Phan viet bang', 'hop', 'Viet Nam', 5000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST07', 'Phan khong bui', 'hop', 'Viet Nam', 5000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST08', 'Bong bang', 'cai', 'Viet Nam', 1000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST09', 'But long', 'cay', 'Viet Nam', 5000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST10', 'But long', 'cay', 'Trung Quoc', 7000)

SELECT* FROM HOADON
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1001','23/07/2006','KH01','NV01','320000')
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1002','12/08/2006','KH01','NV02','840000')
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1003','23/08/2006','KH02','NV01','100000')
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1004','01/09/2006','KH02','NV01','180000')
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1005','20/10/2006','KH01','NV02','3800000')
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1006','16/10/2006','KH01','NV03','2430000')
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1007','28/10/2006','KH03','NV03','510000')
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1008','28/10/2006','KH01','NV03','440000')
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1009','28/10/2006','KH03','NV04','200000')
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1010','01/11/2006','KH01','NV01','5200000')
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1011','04/11/2006','KH04','NV03','250000')
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1012','30/11/2006','KH05','NV03','21000')
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1013','12/12/2006','KH06','NV01','5000')
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1014','31/12/2006','KH03','NV02','3150000')
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1015','01/01/2007','KH06','NV01','910000')
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1016','01/01/2007','KH07','NV02','12500')
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1017','02/01/2007','KH08','NV03','35000')
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1018','13/01/2007','KH08','NV03','330000')
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1019','13/01/2007','KH01','NV03','30000')
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1020','14/01/2007','KH09','NV04','70000')
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1021','16/01/2007','KH10','NV03','67500')
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1022','16/01/2007',Null,'NV03','7000')
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1023','17/01/2007',Null,'NV01','330000')

SET DATEFORMAT DMY

SELECT* FROM CTHD
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1001, 'TV02', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1001, 'ST01', 5)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1001, 'BC01', 5)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1001, 'BC02', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1001, 'ST08', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1002, 'BC04', 20)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1002, 'BB01', 20)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1002, 'BB02', 20)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1002, 'BB03', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1004, 'TV01', 20)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1004, 'TV02', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1004, 'TV03', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1004, 'TV04', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1005, 'TV05', 50)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1005, 'TV06', 50)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1001, 'TV07', 20)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1006, 'ST01', 30)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1006, 'ST02', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1007, 'ST03', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1008, 'ST04', 8)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1009, 'ST05', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1010, 'TV07', 50)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1010, 'ST07', 50)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1010, 'ST08', 100)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1010, 'ST04', 50)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1010, 'TV03', 100)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1011, 'ST06', 50)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1012, 'ST07', 3)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1013, 'ST08', 5)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1014, 'BC02', 80)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1014, 'BB02', 100)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1014, 'BC04', 60)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1014, 'BB01', 50)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1015, 'BB02', 30)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1015, 'BB03', 7)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1016, 'TV01', 5)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1017, 'TV02', 1)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1017, 'TV03', 1)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1017, 'TV04', 5)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1018, 'ST04', 6)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1019, 'ST05', 1)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1019, 'ST06', 2)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1020, 'ST07', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1021, 'ST08', 5)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1021, 'TV01', 7)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1021, 'TV02', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1022, 'TV02', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1023, 'ST04', 6)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1023, 'BC01', 5)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1023, 'BC02', 1)

-- CAU 2

SELECT * INTO SANPHAM1 FROM SANPHAM
SELECT * FROM SANPHAM1
SELECT * INTO KHACHHANG1 FROM KHACHHANG
--CAU 3
UPDATE SANPHAM1 SET GIA=GIA*105/100 WHERE NUOCSX='Thai Lan'
-- CAU 4
UPDATE SANPHAM1 SET GIA=GIA*95/100 WHERE NUOCSX='Trung Quoc' AND GIA<10000
-- CAU 5
UPDATE KHACHHANG1 SET LOAIKH='Vip' WHERE (NGDK<'1/1/2007' AND DOANHSO>=10000000) OR  (NGDK>='1/1/2007' AND DOANHSO>=2000000)

-- PHAN 3
-- CAU 1
SELECT MASP,TENSP FROM SANPHAM1 WHERE NUOCSX='Trung Quoc'
-- CAU 2
SELECT MASP,TENSP FROM SANPHAM1 WHERE DVT='cay' OR DVT='quyen'
-- CAU 3
SELECT MASP,TENSP FROM SANPHAM1 WHERE MASP LIKE 'B%01'
-- CAU 4
SELECT MASP,TENSP FROM SANPHAM1 WHERE NUOCSX='Trung Quoc' AND GIA>30000 AND GIA<40000
-- CAU 5
SELECT MASP,TENSP FROM SANPHAM1 WHERE (NUOCSX='Trung Quoc' OR NUOCSX='Thai Lan') AND (GIA>30000 AND GIA<40000)

-- CAU 6

SELECT SOHD,TRIGIA FROM HOADON WHERE (DAY(NGHD)=1 AND MONTH(NGHD)=1 AND YEAR(NGHD)=2007 ) AND (DAY(NGHD)=2 AND MONTH(NGHD)=1 AND YEAR(NGHD)=2007 )


-- CAU 7
SELECT SOHD,TRIGIA FROM HOADON WHERE MONTH(NGHD)=1 AND YEAR(NGHD)=2007 ORDER BY NGHD ASC, TRIGIA DESC

-- LÀM TIẾP NÈ =))
-- CÂU 8
SELECT K.MAKH, HOTEN
FROM KHACHHANG K INNER JOIN HOADON H
ON K.MAKH = H.MAKH
WHERE NGHD = '1/1/2007'
-- CÂU 9
SELECT SOHD, TRIGIA
FROM HOADON H INNER JOIN NHANVIEN N
ON H.MANV = N.MANV
WHERE NGHD = '10/28/2006'
AND HOTEN = 'NGUYEN VAN B'
-- CÂU 10
SELECT DISTINCT S.MASP, TENSP
FROM SANPHAM S INNER JOIN CTHD C
ON S.MASP = C.MASP
AND EXISTS(SELECT *
FROM CTHD C INNER JOIN HOADON H
ON C.SOHD = H.SOHD
AND MONTH(NGHD) = 10 AND YEAR(NGHD) = 2006 AND MAKH IN(SELECT H.MAKH
FROM HOADON H INNER JOIN KHACHHANG K
ON H.MAKH = K.MAKH
WHERE HOTEN = 'NGUYEN VAN A') AND S.MASP = C.MASP)
--CÂU 11
SELECT SOHD
FROM CTHD
WHERE MASP IN ('BB01', 'BB02')
--CÂU 12
SELECT SOHD
FROM CTHD
WHERE MASP IN ('BB01', 'BB02')
AND SL BETWEEN 10 AND 20
--CÂU 13
SELECT SOHD
FROM CTHD A
WHERE A.MASP = 'BB01'
AND SL BETWEEN 10 AND 20
AND EXISTS(SELECT *
FROM CTHD B
WHERE B.MASP = 'BB02'
AND SL BETWEEN 10 AND 20
AND A.SOHD = B.SOHD)
--CÂU 14
SELECT DISTINCT S.MASP, TENSP
FROM SANPHAM S INNER JOIN CTHD C
ON S.MASP = C.MASP
WHERE NUOCSX = 'TRUNG QUOC'
AND C.SOHD IN(SELECT DISTINCT C2.SOHD
FROM CTHD C2 INNER JOIN HOADON H
ON C2.SOHD = H.SOHD
WHERE NGHD ='1/1/2007')
--CÂU 15
SELECT S.MASP, TENSP
FROM SANPHAM S
WHERE NOT EXISTS(SELECT * 
FROM SANPHAM S2 INNER JOIN CTHD C
ON S2.MASP = C.MASP
AND S2.MASP = S.MASP)
--CÂU 16
SELECT S.MASP, TENSP
FROM SANPHAM S
WHERE S.MASP NOT IN(SELECT C.MASP 
FROM CTHD C INNER JOIN HOADON H
ON C.SOHD = H.SOHD
WHERE YEAR(NGHD) = 2006)
--CÂU 17
SELECT S.MASP, TENSP
FROM SANPHAM S
WHERE NUOCSX = 'TRUNG QUOC' AND S.MASP NOT IN(SELECT C.MASP 
FROM CTHD C INNER JOIN HOADON H
ON C.SOHD = H.SOHD
WHERE YEAR(NGHD) = 2006)

-- CÂU 18
SELECT DISTINCT SOHD
FROM  CTHD A
WHERE NOT EXISTS(SELECT *
	FROM  SANPHAM B
	WHERE NUOCSX='SINGAPORE' AND
    NOT EXISTS(SELECT *
	FROM  CTHD C
	WHERE C.MASP=B.MASP AND C.SOHD=A.SOHD))

-- CAU 19
SELECT H.SOHD 
FROM HOADON H
WHERE YEAR(NGHD) = 2006 AND 
	NOT EXISTS(SELECT *
	FROM SANPHAM S
	WHERE NUOCSX = 'SINGAPORE' AND 
	NOT EXISTS(SELECT * 
		FROM CTHD C
		WHERE C.SOHD = H.SOHD
		AND C.MASP = S.MASP))

-- CAU 20
SELECT COUNT(*)
FROM HOADON H
WHERE MAKH NOT IN(SELECT MAKH
FROM KHACHHANG K 
WHERE K.MAKH = H.MAKH)

-- CAU 21
SELECT COUNT(DISTINCT MASP)
FROM CTHD C INNER JOIN HOADON H
ON C.SOHD = H.SOHD
WHERE YEAR(NGHD) = 2006
-- CAU 22
SELECT MAX(TRIGIA) [TRI GIA MAX],MIN(TRIGIA) [TRI GIA MIN] 
FROM  HOADON

-- CAU 23
SELECT AVG(TRIGIA) TB
FROM  HOADON
WHERE YEAR(NGHD)=2006

--CAU 24
SELECT SUM(TRIGIA) AS DOANHTHU
FROM HOADON
WHERE YEAR(NGHD) = 2006

-- CAU 25
SELECT SOHD
FROM HOADON
WHERE TRIGIA = (SELECT MAX(TRIGIA)
FROM HOADON
WHERE YEAR(NGHD) = 2006)

-- CAU 26
SELECT HOTEN
FROM KHACHHANG K INNER JOIN HOADON H
ON K.MAKH = H.MAKH 
AND SOHD = (SELECT SOHD
			FROM HOADON
			WHERE TRIGIA = (SELECT MAX(TRIGIA)
							FROM HOADON))

-- CAU 27
SELECT TOP 3 MAKH, HOTEN
FROM KHACHHANG
ORDER BY DOANHSO DESC

--CAU 28
SELECT MASP, TENSP
FROM SANPHAM
WHERE GIA IN (SELECT DISTINCT TOP 3 GIA
	FROM SANPHAM
	ORDER BY GIA DESC)

-- CAU 29
SELECT MASP, TENSP
FROM SANPHAM
WHERE NUOCSX = 'THAI LAN' AND GIA IN (SELECT DISTINCT TOP 3 GIA
FROM SANPHAM
ORDER BY GIA DESC)

-- CAU 30
SELECT MASP, TENSP
FROM  SANPHAM
WHERE NUOCSX='TRUNG QUOC' AND GIA IN(SELECT TOP 3  GIA
	FROM   SANPHAM
	WHERE  NUOCSX='TRUNG QUOC'
	ORDER BY   GIA DESC) 
-- CAU 31

SELECT TOP 3 MAKH, HOTEN
FROM KHACHHANG
ORDER BY DOANHSO DESC
-- CAU 32
SELECT COUNT(DISTINCT MASP)
FROM SANPHAM
WHERE NUOCSX = 'TRUNG QUOC'
--CAU 33
SELECT NUOCSX, COUNT(DISTINCT MASP) AS TONGSOSANPHAM
FROM SANPHAM
GROUP BY NUOCSX

-- CAU 34
SELECT NUOCSX, MAX(GIA) AS MAX, MIN(GIA) AS MIN, AVG(GIA) AS AVG
FROM SANPHAM
GROUP BY NUOCSX

-- CAU 35
SELECT NGHD, SUM(TRIGIA) AS DOANHTHU
FROM HOADON
GROUP BY NGHD

-- CAU 36
SELECT MASP, COUNT(DISTINCT MASP) AS TONGSO
FROM SANPHAM
WHERE MASP IN(SELECT MASP
FROM CTHD C INNER JOIN HOADON H
ON C.SOHD = H.SOHD
WHERE MONTH(NGHD) = 10 AND YEAR(NGHD) = 2006)
GROUP BY MASP

-- CAU 37
SELECT MONTH(NGHD) AS THANG, SUM(TRIGIA) AS DOANHTHU
FROM HOADON
WHERE YEAR(NGHD) = 2006
GROUP BY MONTH(NGHD)

-- CAU 38
SELECT *
FROM HOADON
WHERE SOHD IN(SELECT SOHD
FROM CTHD
WHERE SL >= 4)

-- CAU 39
SELECT *
FROM HOADON
WHERE SOHD IN(SELECT SOHD
FROM CTHD C INNER JOIN SANPHAM S
ON C.MASP = S.MASP
WHERE NUOCSX = 'VIET NAM' AND SL >= 3)

-- CAU 40
SELECT MAKH, HOTEN
FROM KHACHHANG
WHERE MAKH = (SELECT TOP 1 MAKH
FROM HOADON
GROUP BY MAKH
ORDER BY COUNT(DISTINCT SOHD) DESC)

-- CAU 41
SELECT TOP 1 MONTH(NGHD) AS THANGCODOANHSOMAX
FROM HOADON
WHERE YEAR(NGHD) = 2006
GROUP BY MONTH(NGHD)
ORDER BY SUM(TRIGIA) DESC

-- CAU 42
SELECT MASP, TENSP
FROM SANPHAM
WHERE MASP = (SELECT TOP 1 MASP
FROM CTHD
GROUP BY MASP
ORDER BY SUM(SL) DESC)

-- CAU 43
SELECT NUOCSX,MASP, TENSP
FROM  SANPHAM A
WHERE GIA=(SELECT MAX(GIA)
   FROM  SANPHAM B
   WHERE A.NUOCSX=B.NUOCSX)
GROUP BY NUOCSX,MASP,TENSP

-- CAU 44
SELECT NUOCSX
FROM  SANPHAM
GROUP BY NUOCSX
HAVING COUNT(DISTINCT GIA)>=3

-- CAU 45
SELECT *
FROM  KHACHHANG
WHERE MAKH IN (SELECT A.MAKH
    FROM  HOADON A, KHACHHANG B
    WHERE A.MAKH=B.MAKH AND
      DOANHSO IN (SELECT TOP 10 DOANHSO
        FROM  KHACHHANG
        ORDER BY DOANHSO DESC) 
    GROUP BY A.MAKH
    HAVING COUNT(SOHD)>=ALL(SELECT  COUNT(SOHD)
          FROM  HOADON A, KHACHHANG B
          WHERE A.MAKH=B.MAKH AND
            DOANHSO IN (SELECT TOP 10 DOANHSO
               FROM  KHACHHANG
               ORDER BY DOANHSO DESC)  
          GROUP BY A.MAKH))


